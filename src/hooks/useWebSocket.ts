import { useEffect, useState, useRef } from "react";
import { io, Socket } from "socket.io-client";
import { RaceUpdate, RoundUpdate, WinnerUpdate, VoteUpdate } from "../types/websocketTypes";

const SOCKET_URL = import.meta.env.VITE_WEBSOCKET_URL || "ws://localhost:4001";

console.debug("[DEBUG] üîÑ Connecting to WebSocket:", SOCKET_URL);

// ‚úÖ Singleton to prevent multiple connections
let socketInstance: Socket | null = null;

export const useWebSocket = () => {
  const socketRef = useRef<Socket | null>(null);
  const [raceData, setRaceData] = useState<RaceUpdate | null>(null);
  const [roundData, setRoundData] = useState<RoundUpdate | null>(null);
  const [winnerData, setWinnerData] = useState<WinnerUpdate | null>(null);
  const [voteData, setVoteData] = useState<VoteUpdate | null>(null); // ‚úÖ Vote update

  useEffect(() => {
    if (!socketInstance) {
      console.debug("[DEBUG] üåê Creating new WebSocket connection...");
      socketInstance = io(SOCKET_URL, { transports: ["websocket"] });
    }

    socketRef.current = socketInstance;

    socketInstance.on("connect", () => console.log("[SOCKET] ‚úÖ Connected"));
    socketInstance.on("disconnect", () => console.log("[SOCKET] ‚ùå Disconnected"));

    // ‚úÖ Listen for WebSocket events
    socketInstance.on("raceCreated", (update: RaceUpdate) => {
      console.log("[SOCKET] üèÅ New race created:", update);
      setRaceData(update);
    });

    socketInstance.on("raceUpdate", (update: RaceUpdate) => {
      console.log("[SOCKET] üèÅ Race Update:", update);
      setRaceData(update);
    });

    socketInstance.on("roundUpdate", (update: RoundUpdate) => {
      console.log("[SOCKET] üîÑ Round Update:", update);
      setRoundData(update);

      setRaceData((prevRace) =>
        prevRace ? { ...prevRace, currentRound: update.roundNumber } : prevRace
      );
    });

    socketInstance.on("winnerUpdate", (update: WinnerUpdate) => {
      console.log("[SOCKET] üèÜ Winner Update:", update);
      setWinnerData(update);
    });

    socketInstance.on("voteUpdate", (update: VoteUpdate) => {
      console.log("[SOCKET] üó≥Ô∏è Vote Update received:", update);
      setVoteData(update);
    });

    return () => {
      console.debug("[DEBUG] ‚ùå WebSocket stays active, not closing.");
    };
  }, []);

  return { socket: socketRef.current, raceData, roundData, winnerData, voteData };
};